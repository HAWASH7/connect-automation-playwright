name: Daily Playwright Test

on:
  schedule:
    - cron: "0 7 * * *"   # 9 Ø§Ù„ØµØ¨Ø­ Ø¨ØªÙˆÙ‚ÙŠØª ÙÙ„Ø³Ø·ÙŠÙ† (UTC+2)
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1) Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø±ÙŠØ¨Ùˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Ø¥Ø¹Ø¯Ø§Ø¯ Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3) ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨ÙƒØ¬Ø§Øª
      - name: Install dependencies
        run: npm ci

      # 4) ØªØ«Ø¨ÙŠØª Ù…ØªØµÙØ­Ø§Øª Playwright
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 5) ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙŠØ³ØªØ§Øª (Headless)
      - name: Run Playwright tests
        run: npx playwright test --headless
        continue-on-error: true  # Ø¹Ø´Ø§Ù† ÙŠÙƒÙ…Ù„ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ ÙØ´Ù„

      # 6) Ø±ÙØ¹ HTML report ÙƒÙ€ Artifact
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

      # 7) Ø±ÙØ¹ Ø§Ù„Ù€ screenshots ÙƒÙ€ Artifact
      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: test-results

      # 8) Ø±Ø³Ø§Ù„Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ø¹Ù„Ù‰ Discord (status + Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Run)
      - name: Send result summary to Discord
        if: always()
        run: |
          STATUS="${{ job.status }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸŸ¢"
          else
            EMOJI="ğŸ”´"
          fi

          MSG="$EMOJI **Daily Automation Report**%0AStatus: **$STATUS**%0ARun: $RUN_URL"

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"$MSG\"}" \
            ${{ secrets.DISCORD_WEBHOOK }}

      # 9) Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆÙ„ Screenshot (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯) Ø¹Ù„Ù‰ Discord
      - name: Send first screenshot to Discord
        if: always()
        run: |
          FILE=$(find test-results -type f -name "*.png" | head -n 1 || true)

          if [ -n "$FILE" ]; then
            echo "Found screenshot: $FILE"
            curl -X POST \
              -F "file=@$FILE" \
              -F 'payload_json={"content": "ğŸ–¼ First screenshot from last run"}' \
              ${{ secrets.DISCORD_WEBHOOK }}
          else
            echo "No screenshot found."
          fi

      # 10) Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯) Ø¹Ù„Ù‰ Discord
      - name: Send first video to Discord
        if: always()
        run: |
          VID=$(find test-results -type f \( -name "*.webm" -o -name "*.mp4" \) | head -n 1 || true)

          if [ -n "$VID" ]; then
            echo "Found video: $VID"
            curl -X POST \
              -F "file=@$VID" \
              -F 'payload_json={"content": "ğŸ¥ First video from last run"}' \
              ${{ secrets.DISCORD_WEBHOOK }}
          else
            echo "No video found."
          fi
